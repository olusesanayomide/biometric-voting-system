<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometric Voting System | Authentication</title>
    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --bg: #f8fafc;
            --text: #1e293b;
            --card-bg: #ffffff;
            --border: #e2e8f0;
        }

        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            margin: 0;
        }

        .container { width: 100%; max-width: 500px; }

        h1 { text-align: center; color: var(--text); margin-bottom: 30px; font-size: 1.5rem; }
        h2 { font-size: 1.1rem; margin-top: 0; display: flex; align-items: center; gap: 8px; }

        .box { 
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 24px; 
            margin-bottom: 24px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .input-group { margin-bottom: 16px; }
        
        input { 
            display: block;
            width: 100%; 
            padding: 12px; 
            margin-top: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input:focus { outline: none; border-color: var(--primary); ring: 2px var(--primary); }

        button { 
            width: 100%;
            padding: 12px; 
            cursor: pointer; 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 6px; 
            font-weight: 600;
            font-size: 14px;
            transition: background 0.2s, opacity 0.2s;
            margin-top: 10px;
        }

        button:hover:not(:disabled) { background: var(--primary-hover); }
        button:disabled { opacity: 0.5; cursor: not-allowed; background: #94a3b8; }

        #regBtn { background: var(--success); }

        .status-text { font-size: 13px; color: #64748b; margin-top: 12px; line-height: 1.4; }
        
        hr { border: 0; border-top: 1px solid var(--border); margin: 30px 0; }

        h3 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; }
        
        pre { 
            background: #1e293b; 
            color: #38bdf8;
            padding: 15px; 
            border-radius: 8px; 
            font-size: 13px;
            overflow-x: auto;
            max-height: 200px;
            border: 1px solid #334155;
        }

        .badge {
            background: #dcfce7;
            color: #166534;
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 11px;
            font-weight: 700;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Voter Identity Portal</h1>

    <div class="box">
        <h2>1. Enrollment <span class="badge">Setup</span></h2>
        <p class="status-text">Verification required for first-time biometric setup.</p>
        
        <div class="input-group">
            <input type="text" id="regIdNumber" placeholder="Matric Number">
            <input type="password" id="regPin" placeholder="Security PIN">
        </div>
        
        <button onclick="loginForRegistration()">Verify Identity</button>
        <button id="regBtn" onclick="registerBiometric()" disabled>Enroll Biometrics</button>
        <p id="status" class="status-text">Please verify identity to enable enrollment.</p>
    </div>

    <div class="box">
        <h2>2. Passwordless Login <span class="badge" style="background:#e0e7ff; color:#3730a3">Secure</span></h2>
        <p class="status-text">Enter your ID to authenticate using your device sensor.</p>
        
        <input type="text" id="loginIdNumber" placeholder="Matric Number">
        <button id="bioLoginBtn" onclick="loginBiometric()">Login with Fingerprint</button>
        <p id="bioStatus" class="status-text">No PIN required for registered devices.</p>
    </div>

    <h3>Activity Logs</h3>
    <pre id="log">System ready...</pre>
</div>
    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
    <script>
        const { startRegistration, startAuthentication } = SimpleWebAuthnBrowser;
        let jwt = '';

        function log(msg) {
            const logElem = document.getElementById('log');
            logElem.innerText = typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg;
        }

        // Modified Login for Onboarding/Registration
        async function loginForRegistration() {
            const id = document.getElementById('regIdNumber').value;
            const pin = document.getElementById('regPin').value;
            try {
                const response = await fetch('http://localhost:3000/auth/login-pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identificationNumber: id, pin })
                });
                const data = await response.json();
                if (data.access_token) {
                    jwt = data.access_token;
                    document.getElementById('regBtn').disabled = false;
                    log("Identity Verified. You can now enroll your biometrics.");
                } else {
                    log("Login failed: " + JSON.stringify(data));
                }
            } catch (err) { log("Error: " + err.message); }
        }

        // THE PASSWORDLESS LOGIN FUNCTION
        async function loginBiometric() {
            const id = document.getElementById('loginIdNumber').value;
            if (!id) return log("Please enter your Matric Number first.");

            try {
                log("Fetching biometric challenge for: " + id);

                // 1. Request options using ONLY the Matric No (Public Route)
                const optionsRes = await fetch('http://localhost:3000/auth/login/biometric-options', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identificationNumber: id })
                });

                if (!optionsRes.ok) throw new Error("User not found or no biometrics registered.");
                const optionsJSON = await optionsRes.json();

                log("Challenge received. Please scan your fingerprint...");

                // 2. Trigger Device Biometric Prompt
                const asseResponse = await startAuthentication(optionsJSON);
                log("Device verified! Finalizing with server...");

                // 3. Verify the hardware signature on the backend
                const verifyRes = await fetch('http://localhost:3000/auth/login/biometric-verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        identificationNumber: id, // Identifying who is responding
                        ...asseResponse 
                    })
                });

                const verifyData = await verifyRes.json();
                
                if (verifyData.access_token) {
                    jwt = verifyData.access_token; 
                    log("SUCCESS: Passwordless Login Verified! Access Token Received.");
                } else {
                    log("Server Verification Failed: " + JSON.stringify(verifyData));
                }
            } catch (err) {
                log("Auth Error: " + err.message);
            }

            
        }
 async function registerBiometric() {
    try {
        log("Fetching registration options...");
        
        // 1. Get options from backend 
        // IMPORTANT: Ensure this URL matches your @Get or @Post in AuthController
        const optionsRes = await fetch('http://localhost:3000/auth/register/challenge', {
            headers: { 'Authorization': `Bearer ${jwt}` }
        });

        // Check if the server actually returned a 200 OK
        if (!optionsRes.ok) {
            const errorData = await optionsRes.json();
            throw new Error(errorData.message || "Failed to fetch options from server");
        }

        const optionsJSON = await optionsRes.json();
        
        // Safety Check: If optionsJSON is undefined or missing challenge, throw error
        if (!optionsJSON || !optionsJSON.challenge) {
            throw new Error("Server returned invalid options (missing challenge)");
        }

        log("Options received. Triggering biometric prompt...");

        // 2. Trigger Browser Biometric Prompt
        const regResponse = await startRegistration(optionsJSON);
        log("Biometric captured! Sending to server for verification...");

        // 3. Send response back to server
        const verifyRes = await fetch('http://localhost:3000/auth/register/verify', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${jwt}` 
            },
            body: JSON.stringify(regResponse)
        });

        const verifyData = await verifyRes.json();
        log(verifyData.success ? "SUCCESS: Biometric Registered!" : "FAILED: " + JSON.stringify(verifyData));
    } catch (err) {
        log("WebAuthn Error: " + err.name + " - " + err.message);
        console.error(err);
    }
}
        // ... (Keep your existing registerBiometric function here) ...
    </script>
</body>